<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPIB-AMD - Actual Bureau Workflow for APMV Processing</title>
    <style>
        /* --- CSS Variables --- */
        :root {
            --primary-color: #005ea2; /* DBM Blue */
            --primary-hover-color: #003e6f;
            --secondary-color: #5c6670; /* Softer gray */
            --secondary-hover-color: #4a545e;
            --danger-color: #dc3545; /* Standard Danger */
            --danger-hover-color: #c82333;
            --success-color: #198754; /* Standard Success */
            --info-color: #0a58ca; /* Indigo for Info */
            --warning-color: #f59e0b; /* Amber/Yellow for Warning */
            --light-bg-color: #f9fafb;
            --medium-bg-color: #f3f4f6;
            --dark-bg-color: #e5e7eb;
            --border-color: #d1d5db;
            --text-color: #1f2937;
            --muted-text-color: #6b7280;
            --white-color: #fff;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --input-bg-color: #fff;
            --header-footer-bg: #f1f3f5;
            --invalid-border-color: #ef4444; /* Tailwind Red-500 for errors */
            --invalid-bg-color: #fee2e2; /* Tailwind Red-100 */
        }

        /* --- General Styles --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* Modern System Font Stack */
            line-height: 1.7; margin: 0; padding: 0; background-color: var(--light-bg-color); color: var(--text-color);
            display: flex; flex-direction: column; min-height: 100vh;
        }
        .app-header { background-color: var(--header-footer-bg); padding: 20px 35px; border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .app-header h1 { margin: 0; font-size: 1.85em; font-weight: 600; color: var(--primary-hover-color); text-align: center; }
        .main-content { padding: 30px 35px 35px 35px; flex-grow: 1; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .panel { background: var(--white-color); padding: 30px 35px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid var(--border-color); margin-bottom: 30px; }
        h2, h3 { color: #111827; border-bottom: 1px solid var(--medium-bg-color); padding-bottom: 14px; margin-top: 0; margin-bottom: 28px; font-weight: 600; }
        h2 { font-size: 1.55em; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        h2 .step-indicator { font-size: 0.85em; font-weight: 600; color: var(--primary-color); margin-left: auto; padding-left: 15px; background-color: #e0e7ff; /* Lighter Indigo */ padding: 5px 12px; border-radius: 12px; white-space: nowrap; }
        h3 { font-size: 1.25em; color: var(--primary-hover-color); border-bottom: none; margin-bottom: 20px; }
        p.instructions, p.info-note { margin-bottom: 25px; background-color: #eef2ff; border: 1px solid #c7d2fe; color: #4338ca; padding: 18px; border-radius: var(--border-radius); font-size: 1.05em; line-height: 1.7; }
        p.important-note { background-color: #fffbeb; border: 1px solid #fde68a; color: #b45309; padding: 20px; border-radius: var(--border-radius); font-size: 1.05em; line-height: 1.7; margin-bottom: 30px; font-weight: 500; }
        .final-instructions { background-color: #f0fdf4; border-color: #bbf7d0; color: #15803d; }
        .thank-you-message { display: none; padding: 25px; margin-top: 30px; text-align: center; font-size: 1.15em; background-color: var(--success-color); color: white; border-radius: var(--border-radius); box-shadow: 0 4px 8px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-out; }

        /* --- Step Form Structure --- */
        .step-content { display: none; animation: fadeIn 0.6s ease-in-out; }
        .step-content.active-step { display: block; }
        .navigation-area { /* Wrapper for validation message + controls */
            padding: 20px 0;
            margin-top: 15px;
            border-top: 1px solid var(--medium-bg-color);
        }
        .navigation-controls { display: flex; justify-content: space-between; }
        .validation-prompt {
            color: var(--danger-color);
            font-weight: 500;
            text-align: right;
            margin-bottom: 10px;
            min-height: 1.5em; /* Reserve space */
            font-size: 0.95em;
            display: none; /* Hidden by default */
        }
        .validation-prompt.visible { display: block; animation: fadeIn 0.3s; }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%{box-shadow: inset 0 0 10px rgba(0,94,162,0.1);} 50%{box-shadow: inset 0 0 18px rgba(0,94,162,0.25);} 100%{box-shadow: inset 0 0 10px rgba(0,94,162,0.1);}}
        @keyframes slideIn { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(15px); } }

        /* --- Step 1: Role Availability --- */
        /* Styles mostly unchanged */
        #role-availability-list { list-style: none; padding: 0; margin: 0; }
        .availability-item { background-color: var(--white-color); padding: 20px 25px; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        .availability-item-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .availability-item-header label { font-weight: 600; font-size: 1.1em; flex-grow: 1; cursor: pointer; }
        .availability-item-header .role-details { font-size: 0.9em; color: var(--muted-text-color); flex-basis: 100%; margin-left: 40px; }
        .availability-item input[type="checkbox"].presence-check { width: 1.4em; height: 1.4em; cursor: pointer; flex-shrink: 0; accent-color: var(--primary-color); }
        .availability-item-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px 25px; padding-left: 40px; border-left: 3px solid var(--medium-bg-color); margin-left: 5px; padding-top: 15px; margin-top: 10px; }
        .availability-item-controls.hidden { display: none; }
        .control-group { margin-bottom: 10px; }
        .control-group label { display: block; font-size: 0.98em; font-weight: 500; margin-bottom: 6px; color: #333; }
        .control-group .sub-label { font-size: 0.85em; color: var(--muted-text-color); display: block; margin-bottom: 8px; }
        .availability-item input[type="number"] { width: 80px; padding: 8px 10px; font-size: 1em; border: 1px solid var(--border-color); border-radius: var(--border-radius); text-align: center; }
        .availability-item input[type="number"]:disabled { background-color: var(--medium-bg-color); color: var(--muted-text-color); cursor: not-allowed; }
        .availability-item input[type="text"] { width: 100%; box-sizing: border-box; padding: 8px 10px; font-size: 1em; border: 1px solid var(--border-color); border-radius: var(--border-radius); }
        .availability-item input[type="text"]:disabled { background-color: var(--medium-bg-color); color: var(--muted-text-color); cursor: not-allowed; }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 30px; margin-right: 10px; vertical-align: middle;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--secondary-color); transition: .4s; border-radius: 30px; }
        .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--success-color); }
        input:not(:checked) + .toggle-slider { background-color: var(--secondary-color); }
        input:checked + .toggle-slider:before { transform: translateX(30px); }
        .toggle-label { font-size: 1em; vertical-align: middle; color: var(--muted-text-color); }
        input:checked ~ .toggle-label { color: var(--text-color); font-weight: 500; }
        .substitute-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
        .substitute-section.hidden { display: none; }
        /* Invalid State for Step 1 */
        .availability-item.invalid { border-left: 6px solid var(--danger-color) !important; background-color: var(--invalid-bg-color); }
        input.invalid { border-color: var(--danger-color) !important; box-shadow: 0 0 0 1px var(--danger-color) !important; }


        /* --- Step 2: Design Workflow --- */
        /* Styles mostly unchanged */
        #step-2 .design-container { display: flex; gap: 30px; flex-wrap: wrap; }
        #step-2 .design-controls { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        #role-palette-panel { width: 340px; flex-shrink: 0; min-width: 300px; height: fit-content; align-self: flex-start; }
        #role-palette { list-style: none; padding: 5px; margin: 0; max-height: 70vh; overflow-y: auto; padding-right: 8px; }
        #palette-help-text { font-size: 0.9em; color: var(--muted-text-color); margin-top: -15px; margin-bottom: 15px; padding-left: 5px; line-height: 1.5; }
        .role-item { background: var(--white-color); border: 1px solid var(--border-color); padding: 14px 18px 14px 40px; margin-bottom: 12px; border-radius: var(--border-radius); cursor: grab; font-size: 1.02em; transition: all 0.25s ease; user-select: none; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .role-item:hover { border-color: var(--primary-color); box-shadow: 0 4px 8px rgba(0,0,0,0.08); transform: scale(1.02); }
        .role-item .role-name { font-weight: 600; display: block; color: var(--text-color); }
        .role-item .role-level { font-size: 0.9em; color: var(--muted-text-color); }
        .role-item.dragging { opacity: 0.5; transform: scale(0.97); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .role-item::before { content: '⠿'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted-text-color); font-size: 1.5em; line-height: 1; opacity: 0.5; cursor: grab; transition: color 0.25s ease; }
        .role-item:hover::before { color: var(--primary-color); opacity: 0.8; }
        #workflow-design-panel { flex-grow: 1; min-width: 450px; }
        #step-count { font-size: 1em; font-weight: 500; color: var(--muted-text-color); }
        #workflow-sequence { list-style: none; padding: 25px; margin: 0; min-height: 600px; background-color: #fefefe; border: 2px dashed var(--border-color); border-radius: var(--border-radius); max-height: 75vh; overflow-y: auto; transition: all 0.25s ease; }
        #workflow-sequence.drag-over { border-color: var(--primary-color); background-color: #f0f8ff; border-style: solid; animation: pulse 1.5s infinite ease-in-out; }
        .sequence-item { background-color: var(--white-color); border: 1px solid var(--border-color); padding: 16px 20px; margin-bottom: 14px; border-radius: var(--border-radius); display: flex; justify-content: space-between; align-items: center; font-size: 1.08em; cursor: grab; position: relative; transition: all 0.25s ease, opacity 0.3s ease, transform 0.3s ease; user-select: none; box-shadow: var(--box-shadow); border-left: 6px solid var(--secondary-color); }
        .sequence-item.animate-in { animation: slideIn 0.4s ease-out forwards; opacity: 0; }
        .sequence-item.animate-out { animation: slideOut 0.3s ease-in forwards; }
        .sequence-item:hover { border-color: var(--primary-color); box-shadow: 0 5px 10px rgba(0,0,0,0.1); border-left-color: var(--primary-color); }
        .sequence-item .step-info { flex-grow: 1; margin-right: 18px; display: flex; align-items: center; }
        .sequence-item .step-number { font-weight: bold; margin-right: 12px; color: var(--primary-color); font-size: 1.2em; min-width: 2.5ch; text-align: right; }
        .sequence-item .step-text { display: flex; flex-direction: column; }
        .sequence-item .step-label { font-weight: 600; }
        .sequence-item .step-details { font-size: 0.9em; color: var(--muted-text-color); display: block; line-height: 1.3; }
        .sequence-item .step-actions button { padding: 0; font-size: 1.3em; cursor: pointer; border: none; border-radius: 50%; background-color: transparent; color: var(--danger-color); line-height: 1; transition: all 0.2s ease; font-weight: normal; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
        .sequence-item .step-actions button:hover { background-color: #fee2e2; color: var(--danger-hover-color); transform: rotate(90deg) scale(1.1); }
        .sequence-item .step-actions button:active { transform: scale(1); background-color: #fecaca; }
        .sequence-item.dragging { opacity: 0.4; background: #f0fff0; box-shadow: 0 6px 12px rgba(0,0,0,0.12); cursor: grabbing; transform: scale(1.03); border-left-color: var(--success-color); }
        .drag-over-indicator { height: 6px; background: linear-gradient(90deg, var(--primary-color), var(--info-color)); margin: -4px 0 10px 0; border-radius: 4px; list-style-type: none; opacity: 0.8; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #workflow-sequence .placeholder-message { color: var(--muted-text-color); text-align: center; margin-top: 120px; font-style: italic; font-size: 1.15em; padding: 20px; border: 2px dashed var(--dark-bg-color); border-radius: var(--border-radius); background-color: rgba(0,0,0,0.01); }

        /* --- Step 3: Workarounds --- */
        /* Styles mostly unchanged */
        #workaround-config-area { list-style: none; padding: 5px; margin: 0; max-height: 75vh; overflow-y: auto; padding-right: 8px; }
        .workaround-item { border: 1px solid var(--border-color); padding: 22px 25px; margin-bottom: 22px; border-radius: var(--border-radius); background-color: #fdfdfd; border-left: 6px solid var(--warning-color); }
        .workaround-item-header { font-weight: 600; font-size: 1.15em; margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid var(--medium-bg-color); display: flex; align-items: center; }
        .workaround-item-header .step-number { font-weight: bold; margin-right: 12px; color: var(--primary-color); }
        .workaround-item-header .step-details { font-size: 0.9em; color: var(--muted-text-color); display: block; font-weight: normal; margin-left: auto; text-align: right; }
        .workaround-fields { margin-top: 18px; padding-left: 18px; border-left: 3px solid var(--dark-bg-color); }
        .workaround-fields label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 1em; color: #333; }
        .workaround-fields input[type="text"], .workaround-fields textarea { width: 100%; box-sizing: border-box; padding: 12px 14px; margin-bottom: 18px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1em; background-color: var(--input-bg-color); box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .workaround-fields input[type="text"]:focus, .workaround-fields textarea:focus { border-color: var(--primary-color); outline: 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06), 0 0 0 0.2rem rgba(0, 94, 162, 0.25); }
        .workaround-fields textarea { min-height: 80px; resize: vertical; }
        .no-workaround-info { font-style: italic; color: var(--muted-text-color); margin-top: 18px; padding-left: 18px; font-size: 0.95em; }

        /* --- Step 4: Questionnaire --- */
        #questionnaire-form fieldset { border: 1px solid var(--border-color); padding: 25px 30px; border-radius: var(--border-radius); margin-bottom: 30px; background-color: #fdfdfd; }
        #questionnaire-form legend { font-weight: 600; font-size: 1.2em; padding: 0 10px; color: var(--primary-hover-color); margin-bottom: 15px; }
        #questionnaire-form .question-group { margin-bottom: 30px; padding: 10px; border-radius: var(--border-radius); border: 2px solid transparent; /* For validation highlight */ transition: border-color 0.3s ease; }
        #questionnaire-form .question-group.invalid { border-color: var(--invalid-border-color); background-color: var(--invalid-bg-color); } /* Highlight group */
        #questionnaire-form .question-text { display: block; font-weight: 500; margin-bottom: 15px; font-size: 1.05em; line-height: 1.6; }
        #questionnaire-form .sub-question { margin-left: 25px; margin-bottom: 15px; }
        #questionnaire-form .radio-group label, #questionnaire-form .checkbox-group label { display: block; margin-bottom: 10px; font-weight: normal; font-size: 1em; cursor: pointer; }
        #questionnaire-form input[type="radio"], #questionnaire-form input[type="checkbox"] { margin-right: 10px; cursor: pointer; vertical-align: middle; width: 1.1em; height: 1.1em; accent-color: var(--primary-color); }
        #questionnaire-form textarea, #questionnaire-form input[type="text"].elaboration { width: 100%; box-sizing: border-box; padding: 10px 12px; margin-top: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1em; resize: vertical; min-height: 40px; }
        #questionnaire-form textarea { min-height: 70px; }
        #questionnaire-form input[name$="_other"] { display: none; width: auto; margin-left: 10px; }
        #questionnaire-form input[type="radio"]:checked + input[type="text"] { display: inline-block; }
        #questionnaire-form input.invalid { border-color: var(--danger-color) !important; box-shadow: 0 0 0 2px var(--invalid-border-color) !important; }


        /* --- Step 5: Output --- */
        #respondent-info-form .form-group { margin-bottom: 20px; }
        #respondent-info-form label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 1.05em; color: #333; }
        #respondent-info-form input[type="text"] { width: 100%; box-sizing: border-box; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1em; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); }
        #respondent-info-form input[type="text"]:focus { border-color: var(--primary-color); outline: 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06), 0 0 0 0.2rem rgba(0, 94, 162, 0.25); }
        #respondent-info-form input:required:invalid { border-color: var(--danger-color); }

        #output-panel textarea { width: 100%; box-sizing: border-box; min-height: 450px; max-height: 65vh; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 1em; white-space: pre-wrap; overflow: auto; background-color: #fdfdfd; border: 1px solid var(--border-color); padding: 25px; border-radius: var(--border-radius); line-height: 1.7; margin-top: 25px; margin-bottom: 20px; resize: vertical; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .output-controls { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 18px; justify-content: center; }
        .output-controls .generate-btn { font-size: 1.2em !important; padding: 15px 35px !important; font-weight: 600; }

        /* --- Buttons --- */
        button { padding: 10px 22px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.06); text-decoration: none; display: inline-block; text-align: center; line-height: 1.5; }
        button:hover:not(:disabled) { box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateY(-2px); }
        button:active:not(:disabled) { transform: translateY(0px); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: none; background-color: #ccc !important; color: #777 !important; border-color: #ccc !important; }
        button.primary { background-color: var(--primary-color); color: white; }
        button.primary:hover:not(:disabled) { background-color: var(--primary-hover-color); }
        button.secondary { background-color: var(--secondary-color); color: white; }
        button.secondary:hover:not(:disabled) { background-color: var(--secondary-hover-color); }
        button.danger { background-color: #fef2f2; color: var(--danger-hover-color); border: 1px solid #fecaca; }
        button.danger:hover:not(:disabled) { background-color: var(--danger-color); color: white; border-color: var(--danger-hover-color); }
        button.nav-btn { font-size: 1.1em; font-weight: 600; padding: 12px 28px; }

        /* --- Footer --- */
        .app-footer { text-align: center; padding: 18px 30px; margin-top: 40px; background-color: var(--header-footer-bg); color: var(--muted-text-color); font-size: 0.95em; border-top: 1px solid var(--border-color); }

        /* --- Status Message --- */
        #status-message { padding: 14px 20px; margin: 0 0 25px 0; border-radius: var(--border-radius); font-size: 1.05em; display: none; text-align: center; border: 1px solid transparent; animation: fadeIn 0.35s ease-out; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #status-message.success { background-color: #d1fae5; color: #065f46; border-color: #a7f3d0; display: block;}
        #status-message.error { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; display: block; }
        #status-message.warning { background-color: #fef9c3; color: #854d0e; border-color: #fde047; display: block; }
        #status-message.info { background-color: #dbeafe; color: #1e40af; border-color: #bfdbfe; display: block; }

    </style>
</head>
<body>
    <header class="app-header">
        <h1>Actual Bureau Workflow for APMV Processing</h1>
    </header>

    <main class="main-content">
        <div id="status-message" role="alert" aria-live="polite"></div>

        <p class="important-note">
             <strong>Important Note:</strong> The workflow being defined should precisely illustrate the <strong>actual process</strong> of the review of the Authority to Purchase Motor Vehicle (APMV) request in your Bureau/Regional Office. This includes the handover of the request from its initial receipt (e.g., by Administrative Staff) up to its release to the next office for further evaluation (e.g., Office of the Assistant Secretary for Budget Preparation and Execution / Central Office / next step outside the Bureau).
        </p>
        <p class="info-note">
             <strong>Role Clarification:</strong> For simplicity, roles like "Director" also pertain to "Regional Director", "Assistant Director" to "Assistant Regional Director", etc., within the context of your office's structure.
        </p>

        <!-- Step 1: Role Availability Check -->
        <div id="step-1" class="step-content active-step panel">
             <h2>
                Step 1: Role Availability & Structure
                <span class="step-indicator">Step 1 of 5</span>
            </h2>
             <p class="instructions">
                Please indicate which roles are actively involved in your APMV review process by checking the box next to the role. Provide structural details like division count and personnel numbers where applicable.
             </p>
             <ul id="role-availability-list">
                 <li class="placeholder-message"><i>Loading roles...</i></li>
             </ul>
        </div>

        <!-- Step 2: Design Workflow Sequence -->
        <div id="step-2" class="step-content panel">
             <h2>
                Step 2: Design Workflow Sequence
                 <span class="step-indicator">Step 2 of 5</span>
            </h2>
             <p class="instructions">
                 Drag roles from the "Available Roles" list (right) and drop them into the "Workflow Sequence" area (left). Arrange them in the exact order they occur in your APMV process.
                 <br><strong>Note:</strong> This sequence should reflect both the *assignment/routing* flow (e.g., Admin Staff receives request, routes to Director; Director assigns to Division/Chief BMS; Chief BMS assigns to BMS) and the subsequent *evaluation/review* flow (e.g., BMS evaluates, routes to Supervising BMS, etc.) up to the point the request leaves the Bureau/RO.
                 <br>Click '✕' to remove a step. **This step is required to proceed.**
            </p>
             <div class="design-container">
                 <div id="workflow-design-panel">
                    <div class="design-controls">
                        <button id="clear-workflow-btn" class="danger" onclick="clearDesignedWorkflow()" title="Clear all steps from the sequence below">Clear Sequence</button>
                    </div>
                    <h3>Workflow Sequence <span id="step-count">(0 steps)</span></h3>
                    <ul id="workflow-sequence" aria-label="Current workflow sequence design area. Drop roles here.">
                         <li class="placeholder-message"><i>Drag & Drop Roles Here</i></li>
                    </ul>
                </div>
                 <div id="role-palette-panel">
                     <h3>Available Roles (Bureau/Division)</h3>
                     <small id="palette-help-text">Drag roles below to the sequence area. You can use the same role multiple times.</small>
                    <ul id="role-palette" aria-label="List of available Bureau/Division roles to drag from">
                         <li class="placeholder-message"><i>Loading roles...</i></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Step 3: Configure Workarounds -->
        <div id="step-3" class="step-content panel">
            <h2>
                Step 3: Configure Workarounds
                <span class="step-indicator">Step 3 of 5</span>
            </h2>
             <p class="instructions">
                For each step in your designed workflow (from Step 2), specify the procedures below if the primary person assigned to that role is unavailable (e.g., on leave, official business travel, emergency). This helps ensure process continuity.
            </p>
            <div>
                <h3>Workaround Details</h3>
                <ul id="workaround-config-area" aria-label="Configuration area for role workarounds">
                    <li class="placeholder-message"><i>Workflow steps from Step 2 will appear here.</i></li>
                </ul>
            </div>
        </div>

        <!-- Step 4: Questionnaire -->
        <div id="step-4" class="step-content panel">
            <h2>
                Step 4: Questionnaire
                <span class="step-indicator">Step 4 of 5</span>
            </h2>
             <p class="instructions">
                 Please answer the following questions regarding your current workflow practices and preferences. **All questions in this section are required to proceed.**
                 <br><strong>Note:</strong> Kindly ensure your responses reflect the official stance or common practice of your Bureau/Regional Office.
            </p>
            <form id="questionnaire-form" onsubmit="event.preventDefault();">
                <fieldset>
                    <legend>I. Workflow Alignment and Staffing Arrangement</legend>

                    <div class="question-group" id="qg-1">
                        <span class="question-text">1. Willingness to Adopt Standardized Workflow:<br>Is your Bureau or Regional Office amenable to adopting a standardized workflow for processing APMVs?</span>
                        <div class="radio-group"> <label><input type="radio" name="q1_adopt_std" value="Yes" required> Yes</label> <label><input type="radio" name="q1_adopt_std" value="No" required> No</label> <label><input type="radio" name="q1_adopt_std" value="With reservations" required> With reservations</label> </div>
                        <textarea name="q1_elaborate" placeholder="Kindly elaborate..." class="elaboration"></textarea>
                    </div>

                    <div class="question-group" id="qg-2">
                        <span class="question-text">2. Initial Routing to Director/Regional Director:<br>The proposed workflow requires all APMV requests to be initially routed to the Director/Regional Director, who will determine the appropriate division.</span>
                        <div class="sub-question"> <span class="question-text">a. Does this reflect your current practice?</span> <label><input type="radio" name="q2a_route_dir_current" value="Yes" required> Yes</label> <label><input type="radio" name="q2a_route_dir_current" value="No" required> No</label> </div>
                         <div class="sub-question"> <span class="question-text">b. Would your Director/Regional Director prefer this arrangement?</span> <label><input type="radio" name="q2b_route_dir_prefer" value="Yes" required> Yes</label> <label><input type="radio" name="q2b_route_dir_prefer" value="No" required> No</label> <!-- Removed Unsure --> </div>
                        <textarea name="q2_elaborate" placeholder="Kindly elaborate..." class="elaboration"></textarea>
                    </div>

                    <div class="question-group" id="qg-3">
                         <span class="question-text">3. Administrative Staffing Structure:<br>Does your Bureau/Regional Office currently have separate administrative staff for these tasks?</span>
                         <div class="sub-question"> <span class="question-text">a. Receiving APMV requests addressed to the Bureau?</span> <label><input type="radio" name="q3a_admin_bureau" value="Yes" required> Yes</label> <label><input type="radio" name="q3a_admin_bureau" value="No" required> No</label> </div>
                          <div class="sub-question"> <span class="question-text">b. Receiving and releasing APMV requests for the Director/RD’s Office?</span> <label><input type="radio" name="q3b_admin_director" value="Yes" required> Yes</label> <label><input type="radio" name="q3b_admin_director" value="No" required> No</label> </div>
                         <textarea name="q3_arrangement" placeholder="Please briefly describe the current arrangement..." class="elaboration"></textarea>
                    </div>

                     <div class="question-group" id="qg-4">
                        <span class="question-text">4. Number of Administrative Roles Involved:<br>How many admin roles are currently involved in APMV processing?</span>
                         <div class="radio-group"> <label><input type="radio" name="q4_admin_count" value="One" required> One</label> <label><input type="radio" name="q4_admin_count" value="Two" required> Two (e.g., one for Bureau, one for Director’s Office)</label> <label><input type="radio" name="q4_admin_count" value="Other" required> Other <input type="text" name="q4_admin_count_other" placeholder="Specify..." class="elaboration" style="display: none; width: auto; margin-left: 10px;"></label> </div>
                         <div class="sub-question" style="margin-top: 15px;"> <span class="question-text">Should the APMV system reflect this setup?</span> <label><input type="radio" name="q4_reflect_setup" value="Yes" required> Yes</label> <label><input type="radio" name="q4_reflect_setup" value="No" required> No</label> </div>
                         <textarea name="q4_elaborate" placeholder="Kindly elaborate..." class="elaboration"></textarea>
                    </div>

                    <div class="question-group" id="qg-5">
                        <span class="question-text">5. Preferred Routing Option:<br>Which option does your Bureau/Regional Office prefer?</span>
                        <div class="radio-group" style="display: flex; flex-direction: column; gap: 10px;"> <label><input type="radio" name="q5_route_prefer" value="Route to BMS" required> One admin staff role directly routing to the appropriate BMS.</label> <label><input type="radio" name="q5_route_prefer" value="Route to Director" required> Routing first to the Director/Regional Director for assignment.</label> <label style="display: flex; align-items: center;"><input type="radio" name="q5_route_prefer" value="Other" required style="margin-right: 8px;"> Other <input type="text" name="q5_route_prefer_other" placeholder="Specify..." class="elaboration" style="display: none; margin-left: 10px; flex-grow: 1;"></label> </div>
                        <textarea name="q5_elaborate" placeholder="Kindly elaborate..." class="elaboration"></textarea>
                    </div>
                </fieldset>

                 <fieldset>
                    <legend>II. Additional Comments or Suggestions</legend>
                     <div class="question-group"> <label for="q_comments" class="question-text">Please provide any other comments, suggestions, or considerations:</label> <textarea name="q_comments" id="q_comments" rows="5" placeholder="Enter comments here..."></textarea> </div>
                 </fieldset>
            </form>
        </div>

         <!-- Step 5: Generate & Submit Output -->
        <div id="step-5" class="step-content panel">
             <h2>
                Step 5: Generate & Submit Output
                <span class="step-indicator">Step 5 of 5</span>
             </h2>
             <p class="instructions">
                 Final Step: Please provide your details below, then generate the consolidated description for final review and submission.
             </p>
             <form id="respondent-info-form" onsubmit="event.preventDefault(); generateConsolidatedOutput();">
                <h3>Respondent Information (Required)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="form-group"> <label for="resp-name">Full Name:</label> <input type="text" id="resp-name" name="resp-name" required placeholder="e.g., Juan Dela Cruz"> </div>
                    <div class="form-group"> <label for="resp-position">Position / Designation:</label> <input type="text" id="resp-position" name="resp-position" required placeholder="e.g., Director III / Supervising BMS"> </div>
                    <div class="form-group"> <label for="resp-office">Bureau / Regional Office:</label> <input type="text" id="resp-office" name="resp-office" required placeholder="e.g., BMB-A / DBM RO V"> </div>
                </div>
             </form>
            <div id="output-panel" style="margin-top: 30px;">
                 <h3>Consolidated Output</h3>
                 <textarea id="consolidated-output" readonly aria-label="Generated text description" placeholder="Click 'Generate Consolidated Description' below..."></textarea>
                 <div class="output-controls"> <button type="submit" form="respondent-info-form" class="primary generate-btn" aria-label="Generate description">Generate Consolidated Description</button> <button id="save-txt-btn" class="secondary" onclick="saveConsolidatedDescriptionToFile()" aria-label="Save description to TXT" disabled>Save Description (TXT)</button> </div>
                 <div id="thank-you-message" class="thank-you-message"> <strong>Thank You!</strong><br> We sincerely appreciate the time and effort you allocated to complete this survey. Your input is valuable.<br> We look forward to your continued cooperation. Please ensure you have saved and submitted the generated TXT file. </div>
                 <p class="instructions final-instructions" style="margin-top: 30px;">
                     <strong>Submission Instructions:</strong><br>
                     1. Fill in your Name, Position, and Office above.<br>
                     2. Click "Generate Consolidated Description".<br>
                     3. Review the text in the box above for accuracy.<br>
                     4. Click "Save Description (TXT)" to download the file.<br>
                     5. Submit the downloaded `.txt` file (e.g., `BMB-A_Juan_Dela_Cruz_YYYY-MM-DD_HH-MM-SS.txt`) to the <strong>SPIB-Asset Management Division</strong> by directly sending the file to <strong>Mr. Alvin Vic Q. Estrellanes</strong> via MS Teams chat or email (aestrellanes@dbm.gov.ph).
                 </p>
             </div>
        </div>

        <!-- Navigation Controls -->
        <div class="navigation-area">
            <div id="validation-prompt" class="validation-prompt" aria-live="assertive"></div> <!-- Prompt Area -->
            <div class="navigation-controls">
                 <button id="prev-btn" class="secondary nav-btn" onclick="previousStep()" disabled>Previous Step</button>
                 <button id="next-btn" class="primary nav-btn" onclick="nextStep()">Next Step</button>
            </div>
        </div>

    </main> <!-- End main-content -->

    <footer class="app-footer">
        SPIB-Asset Management Division
    </footer>


<script>
    // --- State Variables ---
    let canonicalWorkflowSteps = []; let availableRoles = []; let designedWorkflowSteps = [];
    let workaroundData = {}; let roleAvailabilityData = {}; let questionnaireData = {};
    let currentStep = 1; const totalSteps = 5;

    // --- Drag & Drop State ---
    let draggedElement = null; let draggedData = null;

    // --- Constants ---
    const PALETTE_ITEM_TYPE = 'app/json/wf-palette'; const SEQUENCE_ITEM_TYPE = 'app/json/wf-sequence';
    const BUREAU_LEVELS = ['Bureau', 'Division']; const DIVISION_ROLE_IDS = ['CBMS', 'SBMS', 'BMS'];
    const REQUIRED_RADIO_GROUPS = ['q1_adopt_std', 'q2a_route_dir_current', 'q2b_route_dir_prefer', 'q3a_admin_bureau', 'q3b_admin_director', 'q4_admin_count', 'q4_reflect_setup', 'q5_route_prefer'];

    // --- Initialization ---
    window.onload = () => { /* Unchanged */ console.log("Initializing SPIB-AMD APMV Workflow Survey v11..."); initializeAndFilterRoles(); initializeAvailabilityData(); initializeQuestionnaireData(); populateRolePalette(); setupDragDropListeners(); setupQuestionnaireListeners(); renderCurrentStep(); updateNavigationButtons(); showStatusMessage("Welcome! Please complete Step 1: Role Availability.", "info", 5000); };

    // --- Role Definition & Filtering ---
    function initializeAndFilterRoles() { /* Unchanged */ canonicalWorkflowSteps=[{stepId:'ADMIN_STAFF',label:'Administrative Staff (Bureau/Office of the Director)',role:'Administrative Staff',level:'Bureau',milestone:!1},{stepId:'BMS',label:'Budget Specialist',role:'Budget and Management Specialist',level:'Division',milestone:!0},{stepId:'SBMS',label:'Supervising BMS',role:'Supervising Budget and Management Specialist',level:'Division',milestone:!0},{stepId:'CBMS',label:'Chief BMS',role:'Chief Budget and Management Specialist',level:'Division',milestone:!0},{stepId:'ADIR',label:'Asst. Director',role:'Assistant Director',level:'Bureau',milestone:!0},{stepId:'DIR',label:'Director',role:'Director',level:'Bureau',milestone:!0}]; availableRoles=[...canonicalWorkflowSteps]; availableRoles.sort((a,b)=>{const lo={'Bureau':1,'Division':2}; if(lo[a.level]!==lo[b.level]){return lo[a.level]-lo[b.level];} if(a.stepId==='ADMIN_STAFF')return -1; if(b.stepId==='ADMIN_STAFF')return 1; const bo=['ADMIN_STAFF','ADIR','DIR']; const ai=bo.indexOf(a.stepId); const bi=bo.indexOf(b.stepId); if(a.level==='Bureau'&&b.level==='Bureau'&&ai !==-1&&bi !==-1){return ai-bi;} return a.label.localeCompare(b.label);}); console.log("Roles initialized:",availableRoles.length); }

    // --- Initialize State Objects ---
    function initializeAvailabilityData() { /* Unchanged */ roleAvailabilityData={divisionCount:0}; availableRoles.forEach(r=>{roleAvailabilityData[r.stepId]={isPresent:!1}; if(r.stepId==='DIR'||r.stepId==='ADIR'){roleAvailabilityData[r.stepId].status='Filled';} if(r.stepId==='ADMIN_STAFF'){roleAvailabilityData[r.stepId].count=1;} if(DIVISION_ROLE_IDS.includes(r.stepId)){roleAvailabilityData[r.stepId].filledCount=0;} if(r.stepId==='SBMS'||r.stepId==='CBMS'){roleAvailabilityData[r.stepId].subRole=''; roleAvailabilityData[r.stepId].subStatus='Acting';}}); console.log("Initialized Availability Data:",roleAvailabilityData); }
    function initializeQuestionnaireData() { /* Removed unsure from q2b */ questionnaireData={q1_adopt_std:null,q1_elaborate:"",q2a_route_dir_current:null,q2b_route_dir_prefer:null,q2_elaborate:"",q3a_admin_bureau:null,q3b_admin_director:null,q3_arrangement:"",q4_admin_count:null,q4_admin_count_other:"",q4_reflect_setup:null,q4_elaborate:"",q5_route_prefer:null,q5_route_prefer_other:"",q5_elaborate:"",q_comments:""}; console.log("Initialized Questionnaire Data"); }

    // --- Unique ID Generation ---
    function generateSurveyInstanceId() { return `survey_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`; }

    // --- UI Rendering & Status ---
    function showStatusMessage(message, type='info', duration=4000){ const sd=document.getElementById('status-message'); if(!sd)return; if(sd.timeoutId){clearTimeout(sd.timeoutId);} sd.textContent=message; sd.className=''; sd.classList.add(type); sd.timeoutId=setTimeout(()=>{if(sd.textContent===message){sd.className=''; sd.textContent='';} sd.timeoutId=null;}, duration); }
    // New function for validation prompts near buttons
    function showValidationPrompt(message) { const vp = document.getElementById('validation-prompt'); if (!vp) return; vp.textContent = message; vp.classList.add('visible'); }
    function clearValidationPrompt() { const vp = document.getElementById('validation-prompt'); if (!vp) return; vp.textContent = ''; vp.classList.remove('visible'); }

    // --- Palette Population ---
    function populateRolePalette() { /* Unchanged */ const p=document.getElementById('role-palette'); p.innerHTML=''; if(!availableRoles||availableRoles.length===0){p.innerHTML='<li class="placeholder-message error">Error: No roles defined.</li>';return;} availableRoles.forEach(s=>{const li=document.createElement('li'); li.className='role-item'; li.draggable=true; li.setAttribute('data-step-id',s.stepId); li.setAttribute('role','option'); li.setAttribute('aria-label',`Draggable role: ${s.label}`); li.title=`Drag role (${s.role}) to sequence`; li.innerHTML=`<span class="role-name">${s.label}</span><span class="role-level">(${s.role})</span>`; p.appendChild(li);}); }

    // --- Step Navigation & Rendering ---
    function goToStep(stepNumber) { /* Unchanged */ if(stepNumber<1||stepNumber>totalSteps){return;} console.log(`Nav to step: ${stepNumber}`); currentStep=stepNumber; document.querySelectorAll('.step-content').forEach(el=>el.classList.remove('active-step')); const te=document.getElementById(`step-${currentStep}`); if(te){te.classList.add('active-step');}else{console.error(`Cannot find step ${currentStep}`); return;} updateNavigationButtons(); renderCurrentStep(); te.scrollIntoView({behavior:'smooth',block:'start'}); }
    function nextStep() { // Uses prompt, calls specific validation
        clearValidationPrompt(); // Clear previous prompts
        if (currentStep === 1 && !validateStep1()) { showValidationPrompt("Please complete all required fields in Step 1."); return; }
        if (currentStep === 2 && designedWorkflowSteps.length === 0) { showValidationPrompt("Step 2 is required: Please design the workflow sequence."); return; }
        if (currentStep === 4 && !validateStep4()) { showValidationPrompt("Step 4 is required: Please answer all highlighted questions."); return; }
        if (currentStep < totalSteps) { goToStep(currentStep + 1); }
    }
    function previousStep() { /* Unchanged */ clearValidationPrompt(); if (currentStep > 1) { goToStep(currentStep - 1); } }
    function updateNavigationButtons() { /* Unchanged */ const pb=document.getElementById('prev-btn'); const nb=document.getElementById('next-btn'); if(!pb||!nb)return; pb.disabled=(currentStep===1); nb.disabled=(currentStep===totalSteps); }

    function renderCurrentStep() {
        if (currentStep === 1) { renderRoleAvailabilityStep(); }
        else if (currentStep === 2) { renderDesignedSequence(); }
        else if (currentStep === 3) { renderWorkaroundConfigUI(); }
        else if (currentStep === 4) { renderQuestionnaireStep(); }
        else if (currentStep === 5) { renderOutputStep(); }
    }

    // --- Step 1: Role Availability ---
    function renderRoleAvailabilityStep() { /* Unchanged */ console.log("Rendering Step 1"); const listEl=document.getElementById('role-availability-list'); if(!listEl)return; listEl.innerHTML=''; const divCountItem=document.createElement('li'); divCountItem.className='availability-item'; divCountItem.style.gridTemplateColumns='1fr auto'; divCountItem.style.background='var(--medium-bg-color)'; divCountItem.innerHTML=`<label for="division-count" style="font-weight: bold; font-size: 1.1em;">Number of Divisions involved:</label><input type="number" id="division-count" min="0" value="${roleAvailabilityData.divisionCount||0}" oninput="handleDivisionCountChange(event)" style="width: 80px;">`; listEl.appendChild(divCountItem); availableRoles.forEach(role=>{const roleData=roleAvailabilityData[role.stepId]; const isPresent=roleData?.isPresent||!1; const item=document.createElement('li'); item.className='availability-item availability-role-item'; item.setAttribute('data-step-id',role.stepId); const hdrDiv=document.createElement('div'); hdrDiv.className='availability-item-header'; const chk=document.createElement('input'); chk.type='checkbox'; chk.id=`check-${role.stepId}`; chk.checked=isPresent; chk.className='presence-check'; chk.onchange=handleAvailabilityChange; hdrDiv.appendChild(chk); const lbl=document.createElement('label'); lbl.htmlFor=`check-${role.stepId}`; lbl.textContent=role.label; hdrDiv.appendChild(lbl); const dtls=document.createElement('span'); dtls.className='role-details'; dtls.textContent=`(${role.role})`; hdrDiv.appendChild(dtls); if(role.stepId==='BMS'){const note=document.createElement('span'); note.className='role-details'; note.style.marginLeft='40px'; note.style.fontStyle='italic'; note.textContent='(Pertains to BMS I, BMS II, Senior BMS)'; hdrDiv.appendChild(note);} item.appendChild(hdrDiv); const ctrlsDiv=document.createElement('div'); ctrlsDiv.className=`availability-item-controls ${!isPresent?'hidden':''}`; ctrlsDiv.id=`controls-${role.stepId}`; if(role.stepId==='DIR'||role.stepId==='ADIR'){const st=roleData?.status||'Filled'; ctrlsDiv.innerHTML=`<div class="control-group"><label>Status:</label><label class="toggle-switch"><input type="checkbox" data-role-status="toggle" ${st==='Filled'?'checked':''} onchange="handleStatusToggle(event, '${role.stepId}')"><span class="toggle-slider"></span></label><span class="toggle-label">${st}</span></div>`;} else if(role.stepId==='ADMIN_STAFF'){const ct=roleData?.count||1; ctrlsDiv.innerHTML=`<div class="control-group"><label for="count-${role.stepId}">Number of Persons:</label><div style="display: flex; align-items: center; gap: 5px;"><input type="number" id="count-${role.stepId}" min="1" value="${ct}" oninput="handleAdminCountChange(event, '${role.stepId}')"><span class="person-label" id="person-label-${role.stepId}">${ct>1?'Persons':'Person'}</span></div></div>`;} else if(DIVISION_ROLE_IDS.includes(role.stepId)){const fc=roleData?.filledCount||0; const divC=roleAvailabilityData.divisionCount||0; const fcGrp=document.createElement('div'); fcGrp.className='control-group'; let maxAttr=''; if(role.stepId!=='BMS'){maxAttr=`max="${divC}"`;} fcGrp.innerHTML=`<label for="filled-${role.stepId}">Number of Filled Positions:</label><input type="number" id="filled-${role.stepId}" min="0" ${maxAttr} value="${fc}" oninput="handleFilledCountChange(event, '${role.stepId}')" ${divC===0&&role.stepId!=='BMS'?'disabled':''}>`; ctrlsDiv.appendChild(fcGrp); if(role.stepId==='SBMS'||role.stepId==='CBMS'){const hasSub=divC>0&&fc<divC; const subR=roleData?.subRole||''; const subS=roleData?.subStatus||'Acting'; const subSect=document.createElement('div'); subSect.className=`substitute-section ${!hasSub?'hidden':''}`; subSect.id=`substitute-${role.stepId}`; subSect.innerHTML=`<p style="font-weight: 500; margin-bottom: 10px; color: var(--danger-color);">Unfilled Position(s) Detected:</p><div class="control-group"><label for="sub-role-${role.stepId}">Who acts as substitute?</label><input type="text" id="sub-role-${role.stepId}" value="${subR}" placeholder="Enter Role/Position" oninput="handleSubstituteChange(event, '${role.stepId}', 'subRole')"></div><div class="control-group"><label>Substitute Status:</label><label class="toggle-switch"><input type="checkbox" data-role-status="toggle" ${subS==='Acting'?'checked':''} onchange="handleSubstituteChange(event, '${role.stepId}', 'subStatus')"><span class="toggle-slider"></span></label><span class="toggle-label">${subS}</span></div>`; ctrlsDiv.appendChild(subSect);}} item.appendChild(ctrlsDiv); listEl.appendChild(item);}); }
    function handleAvailabilityChange(event) { /* Unchanged */ const cb=event.target; const sid=cb.closest('.availability-role-item')?.dataset.stepId; if(!sid)return; const pres=cb.checked; const ctrls=document.getElementById(`controls-${sid}`); if(roleAvailabilityData[sid]){roleAvailabilityData[sid].isPresent=pres; if(ctrls){ctrls.classList.toggle('hidden',!pres);} console.log("Updated avail:", sid, roleAvailabilityData[sid]);}}
    function handleDivisionCountChange(event) { /* Unchanged */ let c=parseInt(event.target.value,10); if(isNaN(c)||c<0){c=0; event.target.value=0;} roleAvailabilityData.divisionCount=c; console.log("Updated Div Count:", c); renderRoleAvailabilityStep();}
    function handleStatusToggle(event, stepId) { /* Unchanged */ const isFilled=event.target.checked; const status=isFilled?'Filled':'OIC'; if(roleAvailabilityData[stepId]){roleAvailabilityData[stepId].status=status; const lbl=event.target.closest('.control-group').querySelector('.toggle-label'); if(lbl)lbl.textContent=status; console.log("Updated status:", stepId, status);}}
    function handleAdminCountChange(event, stepId) { /* Unchanged */ let c=parseInt(event.target.value,10); if(isNaN(c)||c<1){c=1; event.target.value=1;} if(roleAvailabilityData[stepId]){roleAvailabilityData[stepId].count=c; const pl=document.getElementById(`person-label-${stepId}`); if(pl)pl.textContent=c>1?'Persons':'Person'; console.log("Updated Admin count:", stepId, c);}}
    function handleFilledCountChange(event, stepId) { /* Unchanged */ let fc=parseInt(event.target.value,10); const dc=roleAvailabilityData.divisionCount||0; if(isNaN(fc)||fc<0){fc=0;} if(stepId!=='BMS'&&fc>dc){fc=dc;} event.target.value=fc; if(roleAvailabilityData[stepId]){roleAvailabilityData[stepId].filledCount=fc; if(stepId==='SBMS'||stepId==='CBMS'){const ss=document.getElementById(`substitute-${stepId}`); if(ss){ss.classList.toggle('hidden',fc>=dc);}} console.log("Updated filled count:", stepId, fc);}}
    function handleSubstituteChange(event, stepId, field) { // Updated for Acting/OIC text
        if(!roleAvailabilityData[stepId])return; if(field==='subRole'){roleAvailabilityData[stepId].subRole=event.target.value; console.log("Updated sub role:", stepId, event.target.value);} else if(field==='subStatus'){const isActing=event.target.checked; const status=isActing?'Acting':'OIC'; roleAvailabilityData[stepId].subStatus=status; const lbl=event.target.closest('.control-group').querySelector('.toggle-label'); if(lbl)lbl.textContent=status; console.log("Updated sub status:", stepId, status);}}
    function validateStep1() { /* Unchanged */ let ok=true; let firstErr=null; const divRolesPres=DIVISION_ROLE_IDS.some(id=>roleAvailabilityData[id]?.isPresent); if(divRolesPres&&(roleAvailabilityData.divisionCount===undefined||roleAvailabilityData.divisionCount<0)){/*showStatusMessage("Enter # divisions.","error");*/ firstErr=document.getElementById('division-count'); ok=false;} ['DIR','ADIR'].forEach(id=>{if(roleAvailabilityData[id]?.isPresent&&!roleAvailabilityData[id]?.status){/*showStatusMessage(`Select status for ${id}.`,"error");*/ if(!firstErr)firstErr=document.getElementById(`check-${id}`); ok=false;}}); if(roleAvailabilityData.divisionCount>0){['SBMS','CBMS'].forEach(id=>{if(roleAvailabilityData[id]?.isPresent){if(roleAvailabilityData[id]?.filledCount===undefined||roleAvailabilityData[id]?.filledCount<0){/*showStatusMessage(`Enter filled# for ${id}.`,"error");*/ if(!firstErr)firstErr=document.getElementById(`filled-${id}`); ok=false;} const needsSub=roleAvailabilityData[id].filledCount<roleAvailabilityData.divisionCount; if(needsSub&&(!roleAvailabilityData[id].subRole||roleAvailabilityData[id].subRole.trim()==='')){/*showStatusMessage(`Specify sub for ${id}.`,"error");*/ if(!firstErr)firstErr=document.getElementById(`sub-role-${id}`); ok=false;}}});} if(roleAvailabilityData['BMS']?.isPresent&&(roleAvailabilityData['BMS']?.filledCount===undefined||roleAvailabilityData['BMS']?.filledCount<0)){/*showStatusMessage(`Enter valid filled# for BMS.`,"error");*/ if(!firstErr)firstErr=document.getElementById(`filled-BMS`); ok=false;} if(!ok&&firstErr){firstErr.scrollIntoView({behavior:'smooth',block:'center'}); firstErr.focus({preventScroll:true}); firstErr.classList?.add('invalid'); /* Highlight invalid field */} return ok;}

    // --- Step 2: Design Workflow ---
    function renderDesignedSequence() { /* Unchanged */ const sl=document.getElementById('workflow-sequence'); const cs=document.getElementById('step-count'); if(!sl||!cs)return; sl.innerHTML=''; const sc=designedWorkflowSteps.length; cs.textContent=`(${sc} ${sc===1?'step':'steps'})`; if(sc===0){sl.innerHTML='<li class="placeholder-message"><i>Drag & Drop Roles Here</i></li>'; return;} designedWorkflowSteps.forEach((st,i)=>{const li=document.createElement('li'); li.className='sequence-item animate-in'; li.draggable=true; li.setAttribute('data-survey-instance-id',st.surveyInstanceId); li.setAttribute('data-index',i); li.setAttribute('role','listitem'); li.setAttribute('aria-label',`Step ${i+1}: ${st.label}. Drag or X`); const info=document.createElement('div'); info.className='step-info'; info.innerHTML=`<span class="step-number">${i+1}.</span><div class="step-text"><span class="step-label">${st.label}</span><span class="step-details">(${st.role} - ${st.level})</span></div>`; const acts=document.createElement('div'); acts.className='step-actions'; const btn=document.createElement('button'); btn.innerHTML='&times;'; btn.title='Remove'; btn.setAttribute('aria-label',`Remove ${i+1}`); btn.onclick=(e)=>{e.stopPropagation(); li.classList.remove('animate-in'); li.classList.add('animate-out'); li.addEventListener('animationend',()=>removeStepFromSequence(st.surveyInstanceId),{once:true});}; acts.appendChild(btn); li.appendChild(info); li.appendChild(acts); sl.appendChild(li);}); }
    function clearDesignedWorkflow() { /* Unchanged */ if(designedWorkflowSteps.length===0){showStatusMessage("Sequence empty.","info");return;} if(confirm("Clear sequence & workarounds?")){designedWorkflowSteps=[]; workaroundData={}; renderCurrentStep(); clearOutput(); showStatusMessage("Sequence cleared.","success");}}

    // --- Step 3: Workarounds ---
    function renderWorkaroundConfigUI() { /* Unchanged */ const ca=document.getElementById('workaround-config-area'); if(!ca){return;} ca.innerHTML=''; if(designedWorkflowSteps.length===0){ca.innerHTML='<li class="placeholder-message"><i>Go to Step 2 first.</i></li>'; return;} let stepsReq=0; designedWorkflowSteps.forEach((st,i)=>{const isB=BUREAU_LEVELS.includes(st.level); const li=document.createElement('li'); li.className='workaround-item'; li.setAttribute('data-survey-instance-id',st.surveyInstanceId); const hdr=document.createElement('div'); hdr.className='workaround-item-header'; hdr.innerHTML=`<span class="step-number">${i+1}.</span><span class="step-label">${st.label}</span><span class="step-details">(${st.role} - ${st.level})</span>`; li.appendChild(hdr); if(isB){stepsReq++; const flds=document.createElement('div'); flds.className='workaround-fields'; const curr=workaroundData[st.surveyInstanceId]||{acting:'',notes:''}; const actL=document.createElement('label'); actL.htmlFor=`workaround-acting-${st.surveyInstanceId}`; actL.textContent='Acting Person/Role:'; const actI=document.createElement('input'); actI.type='text'; actI.id=`workaround-acting-${st.surveyInstanceId}`; actI.value=curr.acting; actI.placeholder="e.g., Alternate Person/Role"; actI.oninput=()=>updateWorkaroundData(st.surveyInstanceId,'acting',actI.value); flds.appendChild(actL); flds.appendChild(actI); const notesL=document.createElement('label'); notesL.htmlFor=`workaround-notes-${st.surveyInstanceId}`; notesL.textContent='Other workarounds if person is unavailable:'; const notesA=document.createElement('textarea'); notesA.id=`workaround-notes-${st.surveyInstanceId}`; notesA.value=curr.notes; notesA.placeholder="e.g., Buddy system, route to next reviewer"; notesA.oninput=()=>updateWorkaroundData(st.surveyInstanceId,'notes',notesA.value); flds.appendChild(notesL); flds.appendChild(notesA); li.appendChild(flds);} else {const ni=document.createElement('div'); ni.className='no-workaround-info'; ni.textContent='(Not applicable)'; li.appendChild(ni);} ca.appendChild(li);}); if(stepsReq===0&&designedWorkflowSteps.length>0){ca.innerHTML='<li class="placeholder-message"><i>No roles needing workarounds found.</i></li>';}}
    function updateWorkaroundData(id, field, value) { /* Unchanged */ if(!workaroundData[id]){workaroundData[id]={acting:'',notes:''};} workaroundData[id][field]=value; console.log(`Updated workaround for ${id}.`); clearOutput();}

    // --- Step 4: Questionnaire ---
    function renderQuestionnaireStep() { /* Unchanged */ console.log("Rendering Step 4"); const form=document.getElementById('questionnaire-form'); if(!form)return; Object.keys(questionnaireData).forEach(key=>{const el=form.elements[key]; if(el){if(el.type==='radio'){const rg=form.querySelectorAll(`input[name="${key}"]`); rg.forEach(r=>{r.checked=(r.value===questionnaireData[key]);});} else if(el.type==='checkbox'){el.checked=questionnaireData[key];} else {el.value=questionnaireData[key]||"";} if(key==='q4_admin_count_other'){el.style.display=(questionnaireData['q4_admin_count']==='Other')?'inline-block':'none';} else if(key==='q5_route_prefer_other'){el.style.display=(questionnaireData['q5_route_prefer']==='Other')?'inline-block':'none';}}}); }
    function setupQuestionnaireListeners() { /* Unchanged */ const f=document.getElementById('questionnaire-form'); if(f){f.addEventListener('change',handleQuestionnaireChange); f.addEventListener('input',handleQuestionnaireChange);} }
    function handleQuestionnaireChange(event) { /* Unchanged + clear validation styles */
        const el=event.target; const name=el.name; const val=(el.type==='checkbox')?el.checked:(el.type==='radio'&&!el.checked)?questionnaireData[name]:el.value;
        if(questionnaireData.hasOwnProperty(name)){
            questionnaireData[name]=val; console.log(`Q Updated: ${name}=${val}`);
            if(name==='q4_admin_count'){const oi=document.querySelector('input[name="q4_admin_count_other"]'); if(oi)oi.style.display=(val==='Other')?'inline-block':'none'; if(val!=='Other')questionnaireData['q4_admin_count_other']='';}
            else if(name==='q5_route_prefer'){const oi=document.querySelector('input[name="q5_route_prefer_other"]'); if(oi)oi.style.display=(val==='Other')?'inline-block':'none'; if(val!=='Other')questionnaireData['q5_route_prefer_other']='';}
            // Clear validation styles on change
            const group = el.closest('.question-group'); if (group) group.classList.remove('invalid');
            if (el.type === 'text') el.classList.remove('invalid');
         }
         clearOutput();
    }
    function validateStep4() { // Updated validation logic
        let isValid = true;
        let firstErrorElement = null;
        const form = document.getElementById('questionnaire-form');
        if (!form) return false;

        // Clear previous validation styles
        form.querySelectorAll('.question-group.invalid').forEach(el => el.classList.remove('invalid'));
        form.querySelectorAll('input.invalid, textarea.invalid').forEach(el => el.classList.remove('invalid'));

        REQUIRED_RADIO_GROUPS.forEach(name => {
            const radios = form.elements[name];
            let groupElement = null;
            if (radios && radios.length > 0) groupElement = radios[0].closest('.question-group'); // Get parent group
            if (!radios || questionnaireData[name] === null) { // Check state, not just radio checked status
                isValid = false;
                if (groupElement && !firstErrorElement) firstErrorElement = groupElement;
                if (groupElement) groupElement.classList.add('invalid');
            }

            // Check "Other" text field if "Other" is selected
            if (questionnaireData[name] === 'Other') {
                const otherInputName = name + '_other';
                const otherInput = form.elements[otherInputName];
                if (otherInput && !otherInput.value.trim()) {
                    isValid = false;
                    if (groupElement && !firstErrorElement) firstErrorElement = otherInput;
                    if (groupElement) groupElement.classList.add('invalid'); // Highlight group too
                    otherInput.classList.add('invalid');
                }
            }
        });

        if (!isValid) {
            // Use validation prompt instead of top status message
            // showStatusMessage("Step 4 is required: Please answer all highlighted questions.", "warning", 5000);
            if (firstErrorElement) {
                firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Try focusing the first actual input within the group
                 const firstInput = firstErrorElement.querySelector('input[type="radio"], input[type="text"], textarea');
                 if (firstInput) firstInput.focus({ preventScroll: true });
            }
        } else {
            // Clear potential border highlights if valid now
             form.querySelectorAll('.question-group.invalid').forEach(el => el.classList.remove('invalid'));
             form.querySelectorAll('input.invalid, textarea.invalid').forEach(el => el.classList.remove('invalid'));
        }

        return isValid;
    }


     // --- Step 5: Output ---
     function renderOutputStep() { /* Unchanged */ console.log("Rendering Output Step"); clearOutput(); }

    // --- Drag and Drop Logic ---
    // (Keep setupDragDropListeners, getDragAfterElement, insertDropIndicator, removeDragIndicator unchanged)
    function setupDragDropListeners() { /* Unchanged */ const p=document.getElementById('role-palette'); const s=document.getElementById('workflow-sequence'); if(!p||!s)return; p.addEventListener('dragstart',(e)=>{if(e.target.classList.contains('role-item')){draggedElement=e.target; const sid=e.target.getAttribute('data-step-id'); const sdata=availableRoles.find(x=>x.stepId===sid); if(!sdata)return; draggedData={type:'palette',id:sid,stepDefinition:sdata}; try{e.dataTransfer.setData(PALETTE_ITEM_TYPE,JSON.stringify(draggedData)); e.dataTransfer.setData('text/plain',sid);}catch(err){e.dataTransfer.setData('text/plain',sid);} e.dataTransfer.effectAllowed='copy'; setTimeout(()=>e.target.classList.add('dragging'),0);}}); p.addEventListener('dragend',(e)=>{if(draggedElement){draggedElement.classList.remove('dragging');} draggedElement=null; draggedData=null;}); s.addEventListener('dragenter',(e)=>{e.preventDefault(); const ip=e.dataTransfer.types.includes(PALETTE_ITEM_TYPE.toLowerCase())||(draggedData?.type==='palette'); const is=e.dataTransfer.types.includes(SEQUENCE_ITEM_TYPE.toLowerCase())||(draggedData?.type==='sequence'); if(ip||is){s.classList.add('drag-over');}else{s.classList.remove('drag-over');}}); s.addEventListener('dragover',(e)=>{e.preventDefault(); const ip=e.dataTransfer.types.includes(PALETTE_ITEM_TYPE.toLowerCase())||(draggedData?.type==='palette'); const is=e.dataTransfer.types.includes(SEQUENCE_ITEM_TYPE.toLowerCase())||(draggedData?.type==='sequence'); if(ip){e.dataTransfer.dropEffect='copy'; s.classList.add('drag-over'); insertDropIndicator(s,e.clientY);}else if(is){e.dataTransfer.dropEffect='move'; s.classList.add('drag-over'); insertDropIndicator(s,e.clientY);}else{e.dataTransfer.dropEffect='none'; removeDragIndicator(s); s.classList.remove('drag-over');}}); s.addEventListener('dragleave',(e)=>{if(!s.contains(e.relatedTarget)){s.classList.remove('drag-over'); removeDragIndicator(s);}}); s.addEventListener('drop',(e)=>{e.preventDefault(); s.classList.remove('drag-over'); removeDragIndicator(s); let ddi=null; try{if(e.dataTransfer.types.includes(PALETTE_ITEM_TYPE.toLowerCase())){ddi=JSON.parse(e.dataTransfer.getData(PALETTE_ITEM_TYPE));}else if(e.dataTransfer.types.includes(SEQUENCE_ITEM_TYPE.toLowerCase())){ddi=JSON.parse(e.dataTransfer.getData(SEQUENCE_ITEM_TYPE));}}catch(err){console.warn("Drop parse error.");} if(!ddi&&draggedData){ddi=draggedData;} if(!ddi){console.error("Drop Error.");showStatusMessage("Drop failed.","error");return;} const tgtEl=getDragAfterElement(s,e.clientY); const tgtId=tgtEl?tgtEl.getAttribute('data-survey-instance-id'):null; if(ddi.type==='palette'&&ddi.stepDefinition){addStepToSequence(ddi.stepDefinition,tgtId);}else if(ddi.type==='sequence'){reorderStepInSequence(ddi.id,tgtId);}else{console.error("Drop Error.");showStatusMessage("Drop failed.","error");} draggedElement=null; draggedData=null;}); s.addEventListener('dragstart',(e)=>{if(e.target.closest('.sequence-item')&&!e.target.closest('button')){const it=e.target.closest('.sequence-item'); draggedElement=it; const iid=it.getAttribute('data-survey-instance-id'); draggedData={type:'sequence',id:iid}; try{e.dataTransfer.setData(SEQUENCE_ITEM_TYPE,JSON.stringify(draggedData)); e.dataTransfer.setData('text/plain',iid);}catch(err){e.dataTransfer.setData('text/plain',iid);} e.dataTransfer.effectAllowed='move'; it.style.cursor='grabbing'; setTimeout(()=>it.classList.add('dragging'),0);}}); s.addEventListener('dragend',(e)=>{if(draggedElement){draggedElement.classList.remove('dragging'); draggedElement.style.cursor='grab'; removeDragIndicator(s);} draggedElement=null; draggedData=null;});}
    function getDragAfterElement(c,y){const els=[...c.querySelectorAll('.sequence-item:not(.dragging)')];return els.reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2; if(offset<0&&offset>closest.offset){return{offset:offset,element:child};}else{return closest;}},{offset:Number.NEGATIVE_INFINITY}).element;}
    function insertDropIndicator(c,y){removeDragIndicator(c); const after=getDragAfterElement(c,y); const ind=document.createElement('li'); ind.className='drag-over-indicator'; ind.setAttribute('aria-hidden','true'); if(after==null){c.appendChild(ind);}else{c.insertBefore(ind,after);}}
    function removeDragIndicator(c){const ind=c.querySelector('.drag-over-indicator'); if(ind){ind.remove();}}

    // --- Sequence Modification Functions ---
    // (Keep addStepToSequence, removeStepFromSequence, reorderStepInSequence unchanged)
    function addStepToSequence(stepDef,targetId=null){if(!stepDef||!stepDef.stepId){return;} const ni={...stepDef,surveyInstanceId:generateSurveyInstanceId()}; let idx=designedWorkflowSteps.length; if(targetId){const tidx=designedWorkflowSteps.findIndex(s=>s.surveyInstanceId===targetId); if(tidx !==-1)idx=tidx;} designedWorkflowSteps.splice(idx,0,ni); showStatusMessage(`Added: ${ni.label}`,"success",1500); renderCurrentStep(); clearOutput();}
    function removeStepFromSequence(idToRemove){const il=designedWorkflowSteps.length; const idx=designedWorkflowSteps.findIndex(s=>s.surveyInstanceId===idToRemove); if(idx===-1)return; const lbl=designedWorkflowSteps[idx].label; designedWorkflowSteps.splice(idx,1); if(workaroundData[idToRemove]){delete workaroundData[idToRemove];} if(designedWorkflowSteps.length<il){showStatusMessage(`Removed: ${lbl}`,"info",1500); renderCurrentStep(); clearOutput();}else{console.warn("Could not remove.");}}
    function reorderStepInSequence(draggedId,targetId){const didx=designedWorkflowSteps.findIndex(s=>s.surveyInstanceId===draggedId); if(didx===-1){return;} const[item]=designedWorkflowSteps.splice(didx,1); let tidx=designedWorkflowSteps.length; if(targetId){const idx=designedWorkflowSteps.findIndex(s=>s.surveyInstanceId===targetId); if(idx !==-1)tidx=idx;} designedWorkflowSteps.splice(tidx,0,item); renderCurrentStep(); clearOutput();}
    function clearDesignedWorkflow() { /* Unchanged */ if(designedWorkflowSteps.length===0){showStatusMessage("Sequence empty.","info");return;} if(confirm("Clear sequence & workarounds?")){designedWorkflowSteps=[]; workaroundData={}; renderCurrentStep(); clearOutput(); showStatusMessage("Sequence cleared.","success");}}

    // --- Output Generation ---
    // (Keep generateConsolidatedOutput and clearOutput unchanged)
    function generateConsolidatedOutput() { /* Unchanged */ const outputTextarea = document.getElementById('consolidated-output'); const saveBtn = document.getElementById('save-txt-btn'); const form = document.getElementById('respondent-info-form'); if (!outputTextarea || !form || !saveBtn) return; if (!form.checkValidity()) { showStatusMessage("Fill Respondent Info.", "warning", 4000); const firstInvalid = form.querySelector(':invalid'); if (firstInvalid) firstInvalid.focus(); form.reportValidity(); return; } const respName = document.getElementById('resp-name').value.trim(); const respPos = document.getElementById('resp-position').value.trim(); const respOffice = document.getElementById('resp-office').value.trim(); const nl = "\n"; let verbose = ""; let structured = ""; verbose += `RESPONDENT INFORMATION\n------------------------\nName:     ${respName}\nPosition: ${respPos}\nOffice:   ${respOffice}\n\n`; structured += `[SECTION_START: RESPONDENT_INFO]\nRESP_NAME: ${respName}\nRESP_POSITION: ${respPos}\nRESP_OFFICE: ${respOffice}\n[SECTION_END: RESPONDENT_INFO]\n\n`; verbose += `ROLE AVAILABILITY & STRUCTURE\n-------------------------------\nDivisions Involved: ${roleAvailabilityData.divisionCount || 0}\n\n`; structured += `[SECTION_START: ROLE_AVAILABILITY]\nAVAIL_DIV_COUNT: ${roleAvailabilityData.divisionCount || 0}\n`; availableRoles.forEach(role => { const data = roleAvailabilityData[role.stepId]; if (!data) return; const isPresent = data.isPresent; verbose += `${role.label}:\n  Present: ${isPresent ? 'Yes' : 'No'}\n`; structured += `AVAIL_${role.stepId}: Present=${isPresent}`; if (isPresent) { if (data.status !== undefined) { verbose += `  Status: ${data.status}\n`; structured += `, Status=${data.status}`; } if (data.count !== undefined) { verbose += `  Count: ${data.count}\n`; structured += `, Count=${data.count}`; } if (data.filledCount !== undefined) { verbose += `  Filled Positions: ${data.filledCount}\n`; structured += `, FilledCount=${data.filledCount}`; } if (role.stepId === 'SBMS' || role.stepId === 'CBMS') { const needsSub = roleAvailabilityData.divisionCount > 0 && data.filledCount < roleAvailabilityData.divisionCount; if (needsSub) { const subR = data.subRole?.trim() || '(Not specified)'; const subS = data.subStatus || 'N/A'; verbose += `  Substitute Role: ${subR}\n  Substitute Status: ${subS}\n`; structured += `, HasSubstitute=true, SubRole=${subR}, SubStatus=${subS}`; } else { structured += `, HasSubstitute=false`; } } } verbose += `\n`; structured += `\n`; }); structured += `[SECTION_END: ROLE_AVAILABILITY]\n\n`; verbose += `DESIGNED WORKFLOW SEQUENCE\n--------------------------\nTotal Steps: ${designedWorkflowSteps.length}\n\n`; structured += `[SECTION_START: WORKFLOW_SEQUENCE]\nSEQ_TotalSteps: ${designedWorkflowSteps.length}\n`; if (designedWorkflowSteps.length === 0) { verbose += "  (No steps designed)\n"; structured += `SEQ_STEP_COUNT: 0\n`; } else { designedWorkflowSteps.forEach((step, i) => { verbose += `  Step ${i + 1}: ${step.label} (${step.role} - ${step.level})\n`; structured += `SEQ_STEP_${i + 1}: Label=${step.label}, ID=${step.stepId}, Instance=${step.surveyInstanceId}\n`; }); } verbose += `\n`; structured += `[SECTION_END: WORKFLOW_SEQUENCE]\n\n`; verbose += `WORKAROUND PROCEDURES\n---------------------\n`; structured += `[SECTION_START: WORKAROUND_DETAILS]\n`; let relevantStepsFound = false; if (designedWorkflowSteps.length === 0) { verbose += "  (No steps designed)\n"; } else { designedWorkflowSteps.forEach((step, i) => { if (BUREAU_LEVELS.includes(step.level)) { relevantStepsFound = true; const data = workaroundData[step.surveyInstanceId] || {}; const acting = data.acting?.trim() || '(Not specified)'; const notes = data.notes?.trim() || '(Not specified)'; verbose += `Step ${i + 1}: ${step.label} (${step.role})\n`; verbose += `  Acting Person/Role: ${acting}\n`; verbose += `  Other Workarounds: ${notes}\n\n`; structured += `WRK_${step.surveyInstanceId}: Acting=${acting}, Notes=${notes}\n`; } }); if (!relevantStepsFound) { verbose += "  (No roles required workaround details)\n"; } } structured += `[SECTION_END: WORKAROUND_DETAILS]\n\n`; verbose += `QUESTIONNAIRE RESPONSES\n-------------------------\n`; structured += `[SECTION_START: QUESTIONNAIRE]\n`; const formatQ = (key, lbl, structPfx, type='text') => { const val=questionnaireData[key]; let dispVal=val||(type==='text'?'(Not specified)':'(Not answered)'); if(type==='radio'&&val===true)dispVal='Yes'; if(type==='radio'&&val===false)dispVal='No'; if(type==='radio'&&key==='q4_admin_count'&&val==='Other')dispVal+=`: ${questionnaireData['q4_admin_count_other']?.trim()||'(Not specified)'}`; if(type==='radio'&&key==='q5_route_prefer'&&val==='Other')dispVal+=`: ${questionnaireData['q5_route_prefer_other']?.trim()||'(Not specified)'}`; verbose+=`${lbl}: ${dispVal}\n`; structured+=`${structPfx}_${key.toUpperCase()}: ${val||'N/A'}\n`; }; verbose += `1. Adopt Standardized Workflow:\n`; formatQ('q1_adopt_std','   Answer','Q1','radio'); formatQ('q1_elaborate','   Elaboration','Q1'); verbose+=nl; verbose += `2. Initial Routing to Director:\n`; formatQ('q2a_route_dir_current','   a. Current practice?','Q2A','radio'); formatQ('q2b_route_dir_prefer','   b. Director prefers?','Q2B','radio'); formatQ('q2_elaborate','   Elaboration','Q2'); verbose+=nl; verbose += `3. Admin Staffing Structure:\n`; formatQ('q3a_admin_bureau','   a. Separate Bureau staff?','Q3A','radio'); formatQ('q3b_admin_director','   b. Separate Director staff?','Q3B','radio'); formatQ('q3_arrangement','   Current Arrangement','Q3'); verbose+=nl; verbose += `4. Number of Admin Roles:\n`; formatQ('q4_admin_count','   Number Involved','Q4','radio'); structured+=`Q4_ADMIN_COUNT_OTHER: ${questionnaireData['q4_admin_count_other']?.trim()||''}\n`; formatQ('q4_reflect_setup','   Reflect in system?','Q4','radio'); formatQ('q4_elaborate','   Elaboration','Q4'); verbose+=nl; verbose += `5. Preferred Routing Option:\n`; formatQ('q5_route_prefer','   Preference','Q5','radio'); structured+=`Q5_ROUTE_PREFER_OTHER: ${questionnaireData['q5_route_prefer_other']?.trim()||''}\n`; formatQ('q5_elaborate','   Elaboration','Q5'); verbose+=nl; verbose += `6. Additional Comments:\n`; formatQ('q_comments','   Comments','Q'); structured += `[SECTION_END: QUESTIONNAIRE]\n\n`; outputTextarea.value = verbose + nl+nl+"### CONSOLIDATABLE DATA ###"+nl+nl + structured + "--- END OF FILE ---" + nl; console.log("Generated output."); showStatusMessage("Description generated!", "success", 2000); saveBtn.disabled = false; }
    function clearOutput() { /* Unchanged */ const ta=document.getElementById('consolidated-output'); if(ta)ta.value=''; const btn=document.getElementById('save-txt-btn'); if(btn)btn.disabled=true; const ty=document.getElementById('thank-you-message'); if(ty)ty.style.display='none'; }

    // Updated filename generation and Thank You message display
    function saveConsolidatedDescriptionToFile() {
        const ta = document.getElementById('consolidated-output'); const saveBtn = document.getElementById('save-txt-btn'); const tyDiv = document.getElementById('thank-you-message'); if (!ta || !saveBtn || !tyDiv) return;
        const text = ta.value; if (!text || text.trim() === '') { showStatusMessage("Generate description first (Step 5).", "warning"); return; }
        const office = document.getElementById('resp-office')?.value.trim() || "Office"; const name = document.getElementById('resp-name')?.value.trim() || "Respondent";
        const now = new Date(); const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
        const sanitize = (str) => str.replace(/[^a-z0-9_\-\s]/gi, '_').replace(/[\s\/]+/g, '_'); // Allow underscore, hyphen, space -> replace space/slash with underscore
        const filename = `${sanitize(office)}_${sanitize(name)}_${timestamp}.txt`;
        try { const blob = new Blob([text], { type: 'text/plain;charset=utf-8' }); const a = document.createElement('a'); a.download = filename; a.href = URL.createObjectURL(blob); a.style.display = 'none'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            tyDiv.style.display = 'block'; // Show thank you
            saveBtn.disabled = true; // Disable save button
            showStatusMessage(`File "${filename}" saved. Please submit as instructed.`, "success", 8000);
        } catch (error) { console.error(`Save error:`, error); showStatusMessage(`Error saving file.`, "error"); }
    }

    // --- Questionnaire Event Handling ---
    // (Keep setupQuestionnaireListeners and handleQuestionnaireChange unchanged)
    function setupQuestionnaireListeners() { const f=document.getElementById('questionnaire-form'); if(f){f.addEventListener('change',handleQuestionnaireChange); f.addEventListener('input',handleQuestionnaireChange);} }
    function handleQuestionnaireChange(event) { const el=event.target; const name=el.name; const val=(el.type==='checkbox')?el.checked:(el.type==='radio'&&!el.checked)?questionnaireData[name]:el.value; if(questionnaireData.hasOwnProperty(name)){questionnaireData[name]=val; console.log(`Q Updated: ${name}=${val}`); const group=el.closest('.question-group'); if(group)group.classList.remove('invalid'); if(el.type==='text'||el.type==='textarea')el.classList.remove('invalid'); if(name==='q4_admin_count'){const oi=document.querySelector('input[name="q4_admin_count_other"]'); if(oi)oi.style.display=(val==='Other')?'inline-block':'none'; if(val!=='Other')questionnaireData['q4_admin_count_other']='';} else if(name==='q5_route_prefer'){const oi=document.querySelector('input[name="q5_route_prefer_other"]'); if(oi)oi.style.display=(val==='Other')?'inline-block':'none'; if(val!=='Other')questionnaireData['q5_route_prefer_other']='';}} clearOutput(); }

    // --- Save/Load JSON (REMOVED) ---

</script>

</body>
</html>